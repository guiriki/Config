# Language: py

# Code:
import os
import json
from PIL import Image
import pytesseract
import fitz

NF_DIR = '/mnt/workspace/Notas_fiscais'
resultados = []

for arquivo in sorted(os.listdir(NF_DIR)):
    if not arquivo.lower().endswith('.pdf'):
        continue
    caminho = os.path.join(NF_DIR, arquivo)
    texto = ''
    paginas = []
    try:
        with fitz.open(caminho) as doc:
            for i, pagina in enumerate(doc):
                pix = pagina.get_pixmap(dpi=300)
                img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
                texto_pagina = pytesseract.image_to_string(img, lang='eng')
                paginas.append({
                    'pagina': i + 1,
                    'texto': texto_pagina
                })
                texto += texto_pagina + '\n-----\n'
    except Exception as e:
        texto += f"[Erro na leitura: {str(e)}]"
    resultados.append({'arquivo': arquivo, 'texto_completo': texto, 'paginas': paginas})

# Salva o JSON com todos os textos extraídos
destino = '/mnt/workspace/Notas_fiscais_textos_extraidos_todos.json'
with open(destino, 'w', encoding='utf-8') as f:
    json.dump(resultados, f, ensure_ascii=False, indent=2)

# Gera resumo para exibição
resumo = []
for nf in resultados:
    t = nf['texto_completo']
    resumo.append({
        'arquivo': nf['arquivo'],
        'trecho_inicial': t[:700],
        'trecho_final': t[-300:] if len(t) > 300 else t
    })

print(json.dumps(resumo, ensure_ascii=False, indent=2))


# Result:
{'stdout': '[\n  {\n    "arquivo": "31250741817115000150550020000023511916154402.pdf",\n    "trecho_inicial": "RECEBEMOS DE PLASTIFORMA INDUSTRIA E COMERCIO LTDA OS PRODUTOS/SERVICOS CONSTANTES DA NOTA FISCAL ABAIXO\\n\\nDATA DE RECEBIMENTO IDENTIFICACAO E ASSINATURA DO RECEBEDOR: NFE NUMERO: 002.351\\nNFE SERIE: 2\\n\\nDANFE CONTROLE DO FISCO\\n\\nDOCUMENTO AUXILIAR DA NOTA\\nFISCAL ELETRONICA\\n0 - Entrada\\n\\nPLASTIFORMA INDUSTRIA E COMERCIO . 1 - Saida CHAVE DE ACESSO\\nNUMERO: 002.351\\nLTDA SERIE: 5 3125 0741 8171 1500 0150 5500 2000 0023 5119 1615 4402\\n\\nRUA SAO TOMAZ DE AQUINO, N 118 - JARDIM k Consulta de autenticidade do portal nacional da NF-e no site\\nINDUSTRIAL, 32.215-240, CONTAGEM - MG PAGINA 1 DE 1 www.nfe.fazenda.gov.br/portal ou no site do Sefaz Autorizador\\n\\nNATUREZA DA OPERACAO . PROTOCOLO DE AUTORIZACAO DE ",\n    "trecho_final": "ACOES COMPLEMENTARES, RESERVADO AO FISCO\\n\\nREFERENTE A ORDEM DE COMPRA N°? 3908,\\n\\nDOCUMENTO EMITIDO POR ME OU EPP OPTANTE PELO SIMPLES NACIONAL. NAO GERA DIREITO A CREDITO\\nFISCAL DE IPI.\\n\\nEmitido pelo aplicativo Soften SIEM - www.softensistemas.com.br - Telefones (17)3245-0866 / (11)3522-9234\\n\\n-----\\n"\n  },\n  {\n    "arquivo": "NF 1513 - SILLION.pdf",\n    "trecho_inicial": "15/07/25, 17:10\\n\\nISS-Curitiba - Sistema de Administragao de ISS\\nNumero da Nota\\n1513\\n\\nSECRETARIA MUNICIPAL DE FINANCAS Data ¢ Hora de Emissao\\n15/07/2025 17:10:03\\n\\nCodigo de Verificacdo\\nC49R7BOA\\n\\nPREFEITURA MUNICIPAL DE CURITIBA\\n\\nNOTA FISCAL DE SERVICOS ELETRONICA - NFS-e\\n\\nPRESTADOR DE SERVICOS.\\n\\nRazao Social: CAETANI & MENDES TECNOLOGIA LTDA\\nCPF / CNPI: 20.878.661/0001-21 Inscricao Municipal: 11 02 0702384-8\\nEndereca: RK. OLIVEIRA VIANA, 000149 - BAIRRO: HAUER - CEP: Tel.: 41 - 996632157\\n\\n81630070\\n\\nMunicipio: CURITIBA UF: PR Email: ECONTABLASSESSORIA@GMAILCOM\\n\\nNome; Razao Social:\\n\\nCPF / CNP:\\nEndereco:\\n\\nMunicipio:\\n\\nTOMADOR DE SERVICOS\\nSILLION SERVICOS DETECNOLOGIA LTDA\\n\\n25.239.869/0001-14 IMU:",\n    "trecho_final": "emitida com respaldo na Lei 73/2009.\\nDocumento emitide por ME ou EPP optante pelo Simples Nacional.\\nMao gera direito a crédito fiscal de IPI.\\n\\nMais informacdes: nota.curitiba.pr.gov.br\\n\\nhttps://isscuritiba.curitiba.pr.gov.br/iss/Principal/frmFramesPgPrincipal.aspx?sParam=MENSAGEM&sLogin=1\\n\\n1\\n\\n-----\\n"\n  },\n  {\n    "arquivo": "NF OC 2602.pdf",\n    "trecho_inicial": "NFS-e - NOTA FISCAL DE SERVICOS ELETRONICA\\n\\nO. Emitida em: Competéncia: Codigo de Verificacao:\\nN°:2025/5 14/07/2025 as 11:20:22 14/07/2025 b8e304a6\\n50.458.441 WARLEY DUARTE LOREDO\\nCPF/CNPJ: 50.458.441/0001-00 Inscri¢ao Municipal: 1468994/001-7\\nle: RUA CORONEL CAMISAO, 381, Oeste - Cep: 30532-040\\nBelo Horizonte MG\\nTelefone: Email:\\n\\nTomador do(s) Servico(s)\\n\\nCPF/CNPJ: 25.239.869/0001-14 Inscri¢ao Municipal: 1030401/001-1\\nSILLION SERVICOS DE TECNOLOGIA LTDA\\n\\nRUA DESEMBARGADOR EDESIO FERNANDES, 122, ANDAR 1, Estoril - Cep: 30494-450\\n\\nBelo Horizonte MG\\n\\nTelefone: Nao Informado Email: Nao Informado\\n\\nDiscriminacao do(s) Servi¢o(s)\\n\\n65 Chicote DVR - Modificacao para Conector Microfit fémea de 4 vias",\n    "trecho_final": "\\n\\nOutras Informacées:\\nChave de acesso no Ambiente de Dados Nacional: 31062001250458441000100250000000000525070971551382.\\n\\nPrefeitura de Belo Horizonte - Secretaria Municipal de Fazenda BH\\nRua Espirito Santo, 605 - 3° andar - Centro - CEP: 30160-919 - Belo Horizonte MG. NOT\\nDuvidas: SIGESP 10\\n\\n-----\\n"\n  },\n  {\n    "arquivo": "NF OC 2776.pdf",\n    "trecho_inicial": "NFS-e - NOTA FISCAL DE SERVICOS ELETRONICA\\n\\nO. Emitida em: Competéncia: Codigo de Verificacao:\\nN°:2025/6 14/07/2025 as 11:28:49 14/07/2025  20c43185\\n50.458.441 WARLEY DUARTE LOREDO\\nCPF/CNPJ: 50.458.441/0001-00 Inscri¢ao Municipal: 1468994/001-7\\nle: RUA CORONEL CAMISAO, 381, Oeste - Cep: 30532-040\\nBelo Horizonte MG\\nTelefone: Email:\\n\\nTomador do(s) Servico(s)\\n\\nCPF/CNPJ: 25.239.869/0001-14 Inscri¢ao Municipal: 1030401/001-1\\nSILLION SERVICOS DE TECNOLOGIA LTDA\\n\\nRUA DESEMBARGADOR EDESIO FERNANDES, 122, ANDAR 1, Estoril - Cep: 30494-450\\n\\nBelo Horizonte MG\\n\\nTelefone: Nao Informado Email: Nao Informado\\n\\nDiscriminacao do(s) Servi¢o(s)\\n\\n28 Chicote DVR - Servic¢o de remocao do resistor 10k e acabamento\\n",\n    "trecho_final": "\\n\\nOutras Informacées:\\nChave de acesso no Ambiente de Dados Nacional: 31062001250458441000100250000000000625074392097953.\\n\\nPrefeitura de Belo Horizonte - Secretaria Municipal de Fazenda BH\\nRua Espirito Santo, 605 - 3° andar - Centro - CEP: 30160-919 - Belo Horizonte MG. NOT\\nDuvidas: SIGESP 10\\n\\n-----\\n"\n  },\n  {\n    "arquivo": "NF OC 3705.2.pdf",\n    "trecho_inicial": "NFS-e - NOTA FISCAL DE SERVICOS ELETRONICA\\n\\nO. Emitida em: Competéncia: Codigo de Verificacao:\\nN°:2025/7 14/07/2025 as 11:32:26 14/07/2025  88a55e64\\n50.458.441 WARLEY DUARTE LOREDO\\nCPF/CNPJ: 50.458.441/0001-00 Inscri¢ao Municipal: 1468994/001-7\\nle: RUA CORONEL CAMISAO, 381, Oeste - Cep: 30532-040\\nBelo Horizonte MG\\nTelefone: Email:\\n\\nTomador do(s) Servico(s)\\n\\nCPF/CNPJ: 25.239.869/0001-14 Inscri¢ao Municipal: 1030401/001-1\\nSILLION SERVICOS DE TECNOLOGIA LTDA\\n\\nRUA DESEMBARGADOR EDESIO FERNANDES, 122, ANDAR 1, Estoril - Cep: 30494-450\\n\\nBelo Horizonte MG\\n\\nTelefone: Nao Informado Email: Nao Informado\\n\\nDiscriminacao do(s) Servi¢o(s)\\n\\n7 Verificagao de reporte no sistema e registro da operac¢ao.\\n- Ord",\n    "trecho_final": "\\n\\nOutras Informacées:\\nChave de acesso no Ambiente de Dados Nacional: 31062001250458441000100250000000000725077088135008.\\n\\nPrefeitura de Belo Horizonte - Secretaria Municipal de Fazenda BH\\nRua Espirito Santo, 605 - 3° andar - Centro - CEP: 30160-919 - Belo Horizonte MG. NOT\\nDuvidas: SIGESP 10\\n\\n-----\\n"\n  },\n  {\n    "arquivo": "NF OC 3744.2.pdf",\n    "trecho_inicial": "NFS-e - NOTA FISCAL DE SERVICOS ELETRONICA\\n\\nO. Emitida em: Competéncia: Codigo de Verificacao:\\nN°:2025/8 14/07/2025 as 11:37:33 14/07/2025  f0868b43\\n50.458.441 WARLEY DUARTE LOREDO\\nCPF/CNPJ: 50.458.441/0001-00 Inscri¢ao Municipal: 1468994/001-7\\nle: RUA CORONEL CAMISAO, 381, Oeste - Cep: 30532-040\\nBelo Horizonte MG\\nTelefone: Email:\\n\\nTomador do(s) Servico(s)\\n\\nCPF/CNPJ: 25.239.869/0001-14 Inscri¢ao Municipal: 1030401/001-1\\nSILLION SERVICOS DE TECNOLOGIA LTDA\\n\\nRUA DESEMBARGADOR EDESIO FERNANDES, 122, ANDAR 1, Estoril - Cep: 30494-450\\n\\nBelo Horizonte MG\\n\\nTelefone: Nao Informado Email: Nao Informado\\n\\nDiscriminacao do(s) Servi¢o(s)\\n\\n8 Teste de verificacao inicial Acessorio STD 155 recondicionado.\\n-",\n    "trecho_final": "\\nOutras Informacées:\\nChave de acesso no Ambiente de Dados Nacional: 31062001250458441000100250000000000825071 227145630.\\n\\nPrefeitura de Belo Horizonte - Secretaria Municipal de Fazenda BH\\nRua Espirito Santo, 605 - 3° andar - Centro - CEP: 30160-919 - Belo Horizonte MG. NOT\\nDuvidas: SIGESP 10\\n\\n-----\\n"\n  },\n  {\n    "arquivo": "NF OC 3903.pdf",\n    "trecho_inicial": "NFS-e - NOTA FISCAL DE SERVICOS ELETRONICA\\n\\nO. Emitida em: Competéncia: Codigo de Verificacao:\\nN°:2025/9 14/07/2025 as 11:44:05 14/07/2025 5867b822\\n50.458.441 WARLEY DUARTE LOREDO\\nCPF/CNPJ: 50.458.441/0001-00 Inscri¢ao Municipal: 1468994/001-7\\nle: RUA CORONEL CAMISAO, 381, Oeste - Cep: 30532-040\\nBelo Horizonte MG\\nTelefone: Email:\\nTomador do(s) Servico(s)\\nCPF/CNPJ: 25.239.869/0001-14 Inscri¢ao Municipal: 1030401/001-1\\n\\nSILLION SERVICOS DE TECNOLOGIA LTDA\\n\\nRUA DESEMBARGADOR EDESIO FERNANDES, 122, ANDAR 1, Estoril - Cep: 30494-450\\n\\nBelo Horizonte MG\\n\\nTelefone: Nao Informado Email: Nao Informado\\n\\nDiscriminacao do(s) Servi¢o(s)\\n\\n224 Servico de reacondicionamento de $TD155 com traseira quebrada, i",\n    "trecho_final": "\\nOutras Informacées:\\nChave de acesso no Ambiente de Dados Nacional: 31062001250458441000100250000000000925077302622650.\\n\\nPrefeitura de Belo Horizonte - Secretaria Municipal de Fazenda BH\\nRua Espirito Santo, 605 - 3° andar - Centro - CEP: 30160-919 - Belo Horizonte MG. NOT\\nDuvidas: SIGESP 10\\n\\n\\n-----\\n"\n  },\n  {\n    "arquivo": "__ NFS-e - 019 -25 __.pdf",\n    "trecho_inicial": "14/07/2025, 14:56 :: NFS-e - Nota Fiscal de Servicos eletrénica ::\\n\\nNFS-e - NOTA FISCAL DE SERVICOS ELETRONICA\\n\\nEmitida em: Competéncia: Codigo de Verifica¢ao:\\nO.\\nN°:2025/19 = 44/07/2025 as 14:55:45 14/07/2025 8d95efa3\\nRJM COMERCIO DE CHICOTES LTDA\\nCPF/CNPJ: 52.299.939/0001-00 Inscri¢ado Municipal: 1505056/001-6\\nla RUA FLAVIO MARQUES LISBOA, 511, ANDAR 1 SALA 1, Barreiro - Cep: 30640-050\\nBelo Horizonte MG\\nTelefone: Email:\\nTomador do(s) Servi¢o(s)\\nCPF/CNPJ: 25.239.869/0001-14 Inscri¢ado Municipal: 1030401/001-1\\n\\nSILLION SERVICOS DE TECNOLOGIA LTDA\\nRUA DESEMBARGADOR EDESIO FERNANDES, 122, ANDAR 1, Estoril - Cep: 30494-450\\n\\nBelo Horizonte MG\\nTelefone: (31)3245-7724 Email: financeiro@sillion.com",\n    "trecho_final": "onal: 31062001252299939000100250000000001925074986010090.\\n\\nPrefeitura de Belo Horizonte - Secretaria Municipal de Fazenda BH\\nRua Espirito Santo, 605 - 3° andar - Centro - CEP: 30160-919 - Belo Horizonte MG. NOTA\\nDuvidas: SIGESP 10\\n\\nhttps://bhissdigital.pbh.gov.br/nfse/pages/exibicaoNFS-e.jsf\\n\\n-----\\n"\n  },\n  {\n    "arquivo": "__ NFS-e21268 - Nota Fiscal de Serviços eletrônica __.pdf",\n    "trecho_inicial": ":: NFS-e - Nota Fiscal de Servicos eletrénica ::\\n\\nhttps://bhissdigital.pbh. gov.br/nfse/pages/exibicaoNFS-e. jsf\\n\\nNFS-e - NOTA FISCAL DE SERVICOS ELETRONICA\\n\\nN°:2025/21268\\n\\nEmitida em:\\n\\n14/07/2025 as 12:49:34\\n\\nASTER GRAF LTDA\\n\\nCPF/CNPJ: 03.284.796/0001-40\\n\\nAster Graf\\n\\npais egreeee\\n\\nTomador do(s) Servi¢o(s)\\n\\nCodigo de Verifica¢ao:\\n\\nb14e9f71\\n\\nCompeténcia:\\n\\n14/07/2025\\n\\nInscrigao Municipal: 0152295/001-7\\n\\nRUA JOSE DE ALENCAR, 700, Nova Suissa - Cep: 30421-148\\n\\nBelo Horizonte\\n\\nTelefone: (31)3314-0300\\n\\nMG\\nEmail: financeiro@astergraf.com.br\\n\\nCPF/CNPJ: 25.239.869/000\\n\\n1-14\\n\\nSILLION SERVICOS DE TECNOLOGIA LTDA\\nRua Desembargador Edesio Fernandes, 122, Andar 1, Estoril - Cep: 30494-450\\n\\nBelo Horizonte\\n",\n    "trecho_final": "e de acesso no Ambiente de Dados Nacional: 31062001203284796000140250000002126825073020299841.\\n\\nPrefeitura de Belo Horizonte - Secretaria Municipal de Fazenda\\nRua Espirito Santo, 605 - 3° andar - Centro - CEP: 30160-919 - Belo Horizonte MG.\\n\\nDuvidas: SIGESP\\n\\nlofl\\n\\nBilin\\n10\\n\\n14/07/2025, 12:34\\n\\n-----\\n"\n  }\n]\n', 'stderr': '', 'returncode': 0, 'packages_installed': []}
